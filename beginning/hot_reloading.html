<!DOCTYPE HTML>
<html lang="en" class="navy sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Hot Reloading - Fyrox Book</title>


        <!-- Custom HTML head -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-ETGWNBR03Y"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-ETGWNBR03Y');
        </script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Fyrox Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/fyrox-book/fyrox-book.github.io/tree/main" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/fyrox-book/fyrox-book.github.io/edit/main/src/beginning/hot_reloading.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="code-hot-reloading"><a class="header" href="#code-hot-reloading">Code Hot Reloading</a></h1>
<p>Fyrox supports code hot reloading (CHR for short), which allows you to recompile the game code while the game is running.
This functionality significantly reduces iteration times and allows rapid prototyping. This way, Rust becomes a sort of
"scripting" language, but with all Rust safety and performance guarantees. CHR in action looks like this:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/vq6P3Npydmw" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<h2 id="how-to-use"><a class="header" href="#how-to-use">How To Use</a></h2>
<blockquote>
<p>⚠️ If you have an existing project from one of the previous versions of the engine, the best way to add support for
CHR is to re-generate the entire project and copy all the assets and game code in the new project. CHR requires very
specific project structure and a small mistake in it could lead to incorrect behavior.</p>
</blockquote>
<p>CHR is quite simple to use - a project generated by the project manager or <code>fyrox-template</code> already has all that is
needed for hot reloading. There are two ways of enabling hot reloading support—using the project manager and doing
the same manually using console commands.</p>
<h3 id="project-manager"><a class="header" href="#project-manager">Project Manager</a></h3>
<p>The easiest way of enabling hot reloading support is to simply click on <code>Hot Reloading</code> checkbox in the project
manager and click <code>Edit</code> or <code>Run</code>:</p>
<p><img src="project_manager_hot_reloading.png" alt="project manager hot reloading" /></p>
<p>Note the small "fire" icon, it means that the project has this feature turned on. You can enable or disable it at any
time.</p>
<h3 id="console-commands"><a class="header" href="#console-commands">Console Commands</a></h3>
<p>Doing the same via console commands requires some bootstrapping. At first, you need to compile your game plugin using the following
command:</p>
<pre><code class="language-shell">RUSTFLAGS="-C prefer-dynamic=yes" cargo build --package game_dylib --no-default-features --features="dylib-engine" --profile dev-hot-reload
</code></pre>
<p>This command will compile the engine DLL (<code>fyrox_dylib.dll/so</code>) and the plugin DLL (<code>game_dylib.dll/so</code>). Please note the
mandatory environment variable <code>RUSTFLAGS="-C prefer-dynamic=yes"</code>. It forces the compiler to link the standard library
dynamically. It is crucial because if not set, the standard library will be duplicated in game plugin and engine,
which will lead to subtle bugs.</p>
<blockquote>
<p>⚠️ Environment variables can be set in a different ways, depending on your OS. On Linux it simply prepends the actual
command, on Windows it requires a <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/set_1#examples">separate command</a>.
Other OSes can have their own ways of setting environment variables.</p>
</blockquote>
<p>The next step is to compile the editor in CHR mode. To do that, run the following command:</p>
<pre><code class="language-shell">RUSTFLAGS="-C prefer-dynamic=yes" cargo run --package editor --no-default-features --features="dylib" --profile dev-hot-reload
</code></pre>
<p>This command will compile the editor in CHR mode and run it. After this, all you need to do is to select build profile
in the editor to be <code>Debug (HR)</code>:</p>
<p><img src="build_profile.png" alt="img.png" /></p>
<p>Once that's done you can run your game by clicking on the green <code>Play</code> button. You can switch between CHR and normal mode
(static linking) at any time. Keep in mind that if you run the editor in CHR mode, it will also reload all changed plugins.</p>
<h2 id="build-profiles"><a class="header" href="#build-profiles">Build Profiles</a></h2>
<p>CHR uses separate build profiles: <code>dev-hot-reload</code> (no optimizations) and <code>release-hot-reload</code> (with optimizations).
Separate build profiles allow you to quickly switch between statically linked plugins and code hot reloading. This could
be useful if you're experiencing some issues with hot reloading (see next section for more info).</p>
<h2 id="stability"><a class="header" href="#stability">Stability</a></h2>
<p>CHR is a very new and experimental feature of the engine. It is based on wildly unsafe functionality which could result
in memory corruption, subtle bugs, etc. If you experience weird behavior of your game after hot reloading, run the
game in normal (static linking) mode instead. Please report any bugs in the <a href="https://github.com/FyroxEngine/Fyrox/issues">issue tracker</a>
of the engine. CHR was tested on two relatively large games - <a href="https://github.com/mrDIMAS/FishFolly">Fish Folly</a> and
<a href="https://github.com/mrDIMAS/StationIapetus">Station Iapetus</a>. You can download these projects and try CHR yourself.</p>
<h2 id="technical-details-and-limitations"><a class="header" href="#technical-details-and-limitations">Technical Details and Limitations</a></h2>
<p>CHR is using the standard operating system (OS) mechanism of shared libraries (DLL for short). Pretty much any OS can load
native code into a running process dynamically from a DLL. Any dynamically loaded library can then be unloaded from the
process memory. This gives a perfect opportunity to reload game code in runtime. It may sound quite easy, but in practice,
there are a lot of issues.</p>
<h3 id="plugin-entities-and-reloading"><a class="header" href="#plugin-entities-and-reloading">Plugin Entities and Reloading</a></h3>
<p>Plugins can supply the engine with a predefined set of entities (such as scripts, etc.). These entities are serialized into
a memory blob before the plugin itself is unloaded. When all plugins are reloaded, this memory blob is used to restore
the state of plugin entities. That being said, pretty much all the plugin entities must be serializable (implement <code>Visit</code> trait).</p>
<h3 id="trait-objects"><a class="header" href="#trait-objects">Trait Objects</a></h3>
<p>Trait objects are very problematic with hot reloading, because internally trait objects contain vtable with function
pointers. These pointers can be easily invalidated if the plugin is unloaded. This applies even to engine trait objects
if they're created directly from the plugin side. The only way to bypass this issue is to use special methods from the
engine to create its trait objects. It is possible to add a lint to clippy to check for such cases (see the respective
<a href="https://github.com/rust-lang/rust-clippy/issues/12819">issue</a>).</p>
<h3 id="dangling-objects"><a class="header" href="#dangling-objects">Dangling Objects</a></h3>
<p>The current plugin system tries its best to remove all plugin entities from the engine internals before reloading plugins.
However, some objects could be overlooked by this system, which could result in crash or memory corruption. The current<br />
approach of preventing from having dangling objects is based on the built-in reflection system—the plugin system iterates
across all fields of every object and checks its assembly name. If the assembly name matches the plugin's assembly name,
then this object must be deleted before the plugin is unloaded.</p>
<h3 id="non-serializable-entities"><a class="header" href="#non-serializable-entities">Non-serializable Entities</a></h3>
<p>Not every object can be serialized, and in this case, the current plugin system calls a special method to restore such
non-serializable entities after hot reloading. Such entities could include server connections, job queues, etc.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../beginning/scripting.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../beginning/editor_overview.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../beginning/scripting.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../beginning/editor_overview.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../editor.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
