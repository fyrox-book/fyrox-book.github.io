<!DOCTYPE HTML>
<html lang="en" class="navy sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Character Controller - Fyrox Book</title>


        <!-- Custom HTML head -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-ETGWNBR03Y"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-ETGWNBR03Y');
        </script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('navy')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Fyrox Book</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/fyrox-book/fyrox-book.github.io/tree/main" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/fyrox-book/fyrox-book.github.io/edit/main/src/tutorials/fps/tutorial-1/fps-tutorial.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="first-person-shooter-tutorial"><a class="header" href="#first-person-shooter-tutorial">First-Person Shooter Tutorial</a></h1>
<p>In this tutorial, we'll create a first-person shooter game.</p>
<p>Before we begin, make sure you know how to create projects and run the game and the editor. Read
<a href="../../../beginning/scripting.html">this chapter</a> first and let's start by creating a new project by executing the following
command in some directory:</p>
<pre><code class="language-shell">fyrox-template init --name=fps --style=3d
</code></pre>
<p>This command will create a new cargo workspace with a few projects inside, we're interested only in <code>game</code> folder
in this tutorial.</p>
<pre><code class="language-text">fps
├───data
├───editor
│   └───src
├───executor
│   └───src
├───executor-android
│   └───src
├───executor-wasm
│   └───src
└───game
    └───src
</code></pre>
<h2 id="player-prefab"><a class="header" href="#player-prefab">Player Prefab</a></h2>
<p>Let's start by creating a <a href="../../../scene/prefab.html">prefab</a> for the player. First-person shooters use quite simple
layouts for characters - usually, it is just a physical capsule with a camera on top of it. Run the editor using the
following command:</p>
<pre><code class="language-shell">cargo run --package editor
</code></pre>
<p><img src="editor_1.png" alt="editor startup" /></p>
<p>By default, <code>scene.rgs</code> scene is loaded, and it is our main scene, but for our player prefab we need a separate scene.
Go to <code>File</code> menu and click <code>New Scene</code>. Save the scene in <code>data/player</code> folder as <code>player.rgs</code>.</p>
<p>Great, now we are ready to create the prefab. Right-click on the <code>__ROOT__</code> node in the World Viewer and find <code>Replace Node</code>
and select <code>Physics -&gt; Rigid Body</code> there. By doing this, we've replaced the root node of the scene to be a rigid body.
This is needed because our player will be moving.</p>
<p><img src="editor_2.png" alt="replace node" /></p>
<p>Select rigid body and set the <code>X/Y/Z Rotation Locked</code> properties to <code>true</code>, <code>Can Sleep</code> - to <code>false</code>. The first three
properties prevents the rigid body from any undesired rotations and the last one prevents the rigid body from being excluded
from simulations.</p>
<p><img src="rigid_body_props.png" alt="rigid body props" /></p>
<p>As you may notice, the editor added a small "warning" icon near the root node - it tells us that the rigid body does not
have a collider. Let's fix that:</p>
<p><img src="editor_3.png" alt="collider node" /></p>
<p>By default, the editor creates a cube collider, but we need a capsule. Let's change that in the Inspector:</p>
<p><img src="editor_4.png" alt="change collider type" /></p>
<p>Now let's change the size of the collider, because default values are disproportional for a humanoid character:</p>
<p><img src="editor_5.png" alt="collider properties" /></p>
<p>This way the capsule is thinner and taller, which roughly corresponds to a 1.8m tall person. Now we need to add a
<a href="../../../scene/camera_node.html">camera</a>, because without it, we couldn't see anything.</p>
<p><img src="editor_6.png" alt="camera" /></p>
<p>Put the camera at the top of the capsule like so:</p>
<p><img src="editor_7.png" alt="camera position" /></p>
<p>Awesome, at this point we're almost done with this prefab. Save the scene (<code>File -&gt; Save Scene</code>) and let's start writing
some code.</p>
<h2 id="code"><a class="header" href="#code">Code</a></h2>
<p>Now we can start writing some code, that will drive our character. Game logic is located in <a href="../../../scripting/script.html">scripts</a>.
Navigate to the <code>fps</code> directory and execute the following command there:</p>
<pre><code class="language-shell">fyrox-template script --name=player
</code></pre>
<p>This command creates a new script for our player in <code>game/src</code> folder. Next, Replace the imports in the <code>lib.rs</code> with the ones below:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span>
<span class="boring">fn main() {
</span>use crate::{player::Player};
use fyrox::{
    core::pool::Handle,
    core::{reflect::prelude::*, visitor::prelude::*},
    plugin::{Plugin, PluginContext, PluginRegistrationContext},
    scene::Scene,
    event::Event,
    gui::message::UiMessage,
};

use std::path::Path;
<span class="boring">}</span></code></pre></pre>
<p>and then add the new module to the <code>lib.rs</code> module by adding the <code>pub mod player;</code> after the imports:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Add this line
pub mod player;

<span class="boring">}</span></code></pre></pre>
<p>All scripts must be registered in the engine explicitly, otherwise they won't work. To do that, add the following
lines to the <code>register</code> method:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>        context
            .serialization_context
            .script_constructors
            .add::&lt;Player&gt;("Player");
<span class="boring">}</span></code></pre></pre>
<p>Great, now the new script is registered, we can head over to the <code>player.rs</code> module and start writing a basic character controller.
First replace the import to the following:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use fyrox::graph::SceneGraph;
use fyrox::{
    core::{
        algebra::{UnitQuaternion, UnitVector3, Vector3},
        pool::Handle,
        reflect::prelude::*,
        type_traits::prelude::*,
        variable::InheritableVariable,
        visitor::prelude::*,
    },
    event::{DeviceEvent, ElementState, Event, MouseButton, WindowEvent},
    keyboard::{KeyCode, PhysicalKey},
    scene::{node::Node, rigidbody::RigidBody},
    script::{ScriptContext, ScriptTrait, ScriptDeinitContext},
    
};

<span class="boring">}</span></code></pre></pre>
<p>Let's start by input
handling. At first, add the following fields to the <code>Player</code> struct:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    #[visit(optional)]
    #[reflect(hidden)]
    move_forward: bool,

    #[visit(optional)]
    #[reflect(hidden)]
    move_backward: bool,

    #[visit(optional)]
    #[reflect(hidden)]
    move_left: bool,

    #[visit(optional)]
    #[reflect(hidden)]
    move_right: bool,

    #[visit(optional)]
    #[reflect(hidden)]
    yaw: f32,

    #[visit(optional)]
    #[reflect(hidden)]
    pitch: f32,
<span class="boring">}</span></code></pre></pre>
<p>The first four fields are responsible for movement in four directions and the last two responsible for camera rotation.
The next thing that we need to do is properly react to incoming OS events to modify the variables that we've just
defined. Add the following code to the <code>on_os_event</code> method like so:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    fn on_os_event(&amp;mut self, event: &amp;Event&lt;()&gt;, _ctx: &amp;mut ScriptContext) {
        match event {
            // Raw mouse input is responsible for camera rotation.
            Event::DeviceEvent {
                event:
                    DeviceEvent::MouseMotion {
                        delta: (dx, dy), ..
                    },
                ..
            } =&gt; {
                // Pitch is responsible for vertical camera rotation. It has -89.9..89.0 degree limits,
                // to prevent infinite rotation.
                let mouse_speed = 0.35;
                self.pitch = (self.pitch + *dy as f32 * mouse_speed).clamp(-89.9, 89.9);
                self.yaw -= *dx as f32 * mouse_speed;
            }
            // Keyboard input is responsible for player's movement.
            Event::WindowEvent {
                event: WindowEvent::KeyboardInput { event, .. },
                ..
            } =&gt; {
                if let PhysicalKey::Code(code) = event.physical_key {
                    let is_pressed = event.state == ElementState::Pressed;
                    match code {
                        KeyCode::KeyW =&gt; {
                            self.move_forward = is_pressed;
                        }
                        KeyCode::KeyS =&gt; {
                            self.move_backward = is_pressed;
                        }
                        KeyCode::KeyA =&gt; {
                            self.move_left = is_pressed;
                        }
                        KeyCode::KeyD =&gt; {
                            self.move_right = is_pressed;
                        }
                        _ =&gt; (),
                    }
                }
            }
            _ =&gt; {}
        }
        // ...
<span class="boring">}</span></code></pre></pre>
<p>This code consists from two major parts:</p>
<ul>
<li>Raw mouse input handling for camera rotations: we're using horizontal movement to rotate the camera around vertical
axis and vertical mouse movement is used to rotate the camera around horizontal axis.</li>
<li>Keyboard input handling for movement.</li>
</ul>
<p>This just modifies the internal script variables, and basically does not affect anything else.</p>
<p>Now let's add camera rotation, at first we need to know the camera handle. Add the following field to the <code>Player</code> struct:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    #[visit(optional)]
    camera: Handle&lt;Node&gt;,
<span class="boring">}</span></code></pre></pre>
<p>We'll assign this field later in the editor, for let's focus on the code. Add the following piece of code at the start of
the <code>on_update</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>        let mut look_vector = Vector3::default();
        let mut side_vector = Vector3::default();
        if let Some(camera) = ctx.scene.graph.try_get_mut(self.camera) {
            look_vector = camera.look_vector();
            side_vector = camera.side_vector();

            let yaw = UnitQuaternion::from_axis_angle(&amp;Vector3::y_axis(), self.yaw.to_radians());
            let transform = camera.local_transform_mut();
            transform.set_rotation(
                UnitQuaternion::from_axis_angle(
                    &amp;UnitVector3::new_normalize(yaw * Vector3::x()),
                    self.pitch.to_radians(),
                ) * yaw,
            );
        }
<span class="boring">}</span></code></pre></pre>
<p>This piece of code is relatively straightforward: at first we're trying to borrow the camera in the scene graph using
its handle, if it is succeeded, we form two quaternions that represent rotations around Y and X axes and combine them
using simple multiplication.</p>
<p>Next thing we'll add movement code. Add the following code to the end of <code>on_update</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    fn on_update(&amp;mut self, ctx: &amp;mut ScriptContext) {
        // Borrow the node to which this script is assigned to. We also check if the node is RigidBody.
        if let Some(rigid_body) = ctx.scene.graph.try_get_mut_of_type::&lt;RigidBody&gt;(ctx.handle) {
            // Form a new velocity vector that corresponds to the pressed buttons.
            let mut velocity = Vector3::new(0.0, 0.0, 0.0);
            if self.move_forward {
                velocity += look_vector;
            }
            if self.move_backward {
                velocity -= look_vector;
            }
            if self.move_left {
                velocity += side_vector;
            }
            if self.move_right {
                velocity -= side_vector;
            }

            let y_vel = rigid_body.lin_vel().y;
            if let Some(normalized_velocity) = velocity.try_normalize(f32::EPSILON) {
                let movement_speed = 240.0 * ctx.dt;
                rigid_body.set_lin_vel(Vector3::new(
                    normalized_velocity.x * movement_speed,
                    y_vel,
                    normalized_velocity.z * movement_speed,
                ));
            } else {
                // Hold player in-place in XZ plane when no button is pressed.
                rigid_body.set_lin_vel(Vector3::new(0.0, y_vel, 0.0));
            }
        }
    }
<span class="boring">}</span></code></pre></pre>
<p>This code is responsible for movement when any of WSAD keys are pressed. At first, it tries to borrow the node to which
this script is assigned to, then it checks if any of the WSAD keys are pressed, and it forms a new velocity vector using
the basis vectors of node. As the last step, it normalizes the vector (makes it unity length) and sets it to the rigid
body velocity.</p>
<p>Our script is almost ready, now all we need to do is to assign it to the player's prefab. Open the <code>player.rgs</code> prefab
in the editor, select <code>Player</code> node and assign the Player script to it. Do not forget to set Camera handle (by clicking
on the small green button and selecting Camera from the list):</p>
<p><img src="script_instance.png" alt="script instance" /></p>
<p>Great, now we're done with the player movement. We can test it our main scene, but at first let's create a simple level.
Open <code>scene.rgs</code> and create a rigid body with a collider. Add a cube as a child of the rigid body and squash it to some
floor-like shape. Select the collider and set its <code>Shape</code> to <code>Trimesh</code>, add a geometry source there and point it to the
floor. Select the rigid body and set its type to <code>Static</code>. You can also add some texture to the cube to make it look
much better.</p>
<p>Now we can instantiate our player prefab in the scene. To do that, find the <code>player.rgs</code> in the Asset Browser, click
on it, hold the button, move the mouse over the scene and release the button. After that the prefab should be instantiated
at the cursor position like so:</p>
<p><img src="prefab_instance.png" alt="prefab instance" /></p>
<p>After that you can click <code>Play</code> button (green triangle above the scene preview) and you should see something like this:</p>
<p><img src="running_game_1.png" alt="running game" /></p>
<p>It should be possible to walk using WSAD keys and rotate the camera using mouse.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>In this tutorial we've created a basic character controller, that allows you to move using keyboard and look around
using mouse. This tutorial showed the main development strategies used in the engine, that should help you to build your
own game. In the next tutorial we'll add weapons.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../tutorials/fps/fps-intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../../tutorials/fps/tutorial-2/fps-tutorial-2.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../tutorials/fps/fps-intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../../tutorials/fps/tutorial-2/fps-tutorial-2.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../../../ace.js"></script>
        <script src="../../../editor.js"></script>
        <script src="../../../mode-rust.js"></script>
        <script src="../../../theme-dawn.js"></script>
        <script src="../../../theme-tomorrow_night.js"></script>

        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
